service: ds-lambda-sample

frameworkVersion: '3'

useDotenv: true
custom:
  stage: ${opt:stage, 'dev'}
  #region: ${env:AWS_REGION}
  #run_role: "arn:aws:iam::847754671288:role/SQS-Lambda-Admin"

provider:
  name: aws
  stage: ${self:custom.stage}
  runtime: python3.9
  #region: ${self:custom.region}
  region: ap-northeast-1
  #iam:
  #  role:
  iamRoleStatements:
    - Effect: Allow
      Action:
        # default
        - logs:CreateLogStream # default
        - logs:PutLogEvents # default
        # - logs:CreateLogGroup
        # CloudWatchReacOnlyAccess
        - 'autoscaling:Describe*'
        - 'cloudwatch:Describe*'
        - 'cloudwatch:Get*'
        - 'cloudwatch:List*'
        - 'logs:Get*'
        - 'logs:List*'
        - 'logs:Describe*'
        - 'logs:TestMetricFilter'
        - 'logs:FilterLogEvents'
        - 'sns:Get*'
        - 'sns:List*'
        - 'iam:GetRole'
        - 'iam:PassRole'
        - 'rds:StartDBInstance'
        - 'rds:StopDBInstance'
        - 'rds:DescribeDBInstances'
      Resource:
        - '*'
  #iam:
  #  role:
  #    ${self:custom.run_role}

# you can define service wide environment variables here
#  environment:
#    variable1: value1

plugins:
  - serverless-offline
  # ${env:XXX}とか使うプラグイン
  - serverless-dotenv-plugin
  #- serverless-jest-plugin
  #- serverless-stack-output # Allows us to output endpoint url to json file

# you can add packaging information here
package:
  patterns:
    - '!node_modules/**'
    - '!func/**'
    - '!*.json'
    - '!README.md'
    - '!serverless.*'
    #- '!**'
    #- include-me.py
    #- include-me-dir/**


functions:
  hello-sample-01:
    handler: func/hello-sample-01/src/lambda_function.handler
    package:
      patterns:
        - func/hello-sample-01/src/*.py
      individually: true

  on-off:
    handler: func/on-off/src/lambda_function.handler
    package:
      patterns:
        - func/on-off/src/*.py
      individually: true
    events:
      - schedule:
          rate: cron(0 15 * * ? *)
          name: on-schduler
          description: 'RDS ON SCHEDULE'
          input:
            switch: "on"
            region: "ap-northeast-1"
            DBInstanceIdentifier: "onoffabcccccc"
      - schedule:  
          rate: cron(50 14 * * ? *)
          name: off-schduler
          description: 'RDS OFF SCHEDULE'
          input:
            switch: "off"
            region: "ap-northeast-1"
            DBInstanceIdentifier: "onoffabcccccc"


